#!/bin/bash -ex

case $(uname -s) in
    Darwin)
        goos=darwin
        logical_cpus=$(sysctl -n hw.logicalcpu)
        brew install bison openssl
        ;;
    Linux)
        goos=linux
        logical_cpus=$(nproc)
        sudo apt-get -y install bison flex libssl-dev

        # Compile a recent libpcap, since the one we'd get via apt-get is old
        # and hits https://github.com/brimsec/zeek/issues/17.
        (
            cd $(mktemp -d)
            wget https://github.com/the-tcpdump-group/libpcap/archive/libpcap-1.9.1.tar.gz
            tar xzvf libpcap-1.9.1.tar.gz
            cd libpcap-libpcap-1.9.1
            ./configure
            make
            sudo make install
        )
        ;;
    *)
        echo "unknown OS" >&2
        exit 1
        ;;
esac

git submodule update --init --recursive
./configure \
	--binary-package --disable-auxtools --disable-broker-tests \
	--disable-python --disable-zeekctl --enable-static-binpac \
	--enable-static-broker --osx-min-version=10.10
sudo make -C build/scripts -j $logical_cpus install/strip
sudo make -C build/src -j $logical_cpus install/strip

# Add additional community Zeek scripts
sudo pip install zkg==2.1.2
declare -a ADDED_ZSCRIPTS=(
    'https://github.com/salesforce/hassh#cfa2315'
    'https://github.com/salesforce/ja3#133f2a1'
)
for ZSCRIPT in "${ADDED_ZSCRIPTS[@]}"; do
    REPO=$(echo "$ZSCRIPT" | cut -f1 -d#)
    NAME=$(echo "$ZSCRIPT" | sed 's/^.*\///' | sed 's/#.*$//')
    COMMIT=$(echo "$ZSCRIPT" | cut -f2 -d#)
    sudo zkg --configfile brim/zkg-config install "$REPO" --force --version "$COMMIT"
    sudo bash -c "echo \"@load ./$NAME\" >> /usr/local/zeek/share/zeek/site/local.zeek"
done

mkdir -p zeek/bin && cp /usr/local/zeek/bin/zeek zeek/bin
mkdir -p zeek/share/zeek
for d in base policy site; do
    cp -R /usr/local/zeek/share/zeek/$d zeek/share/zeek
done
cp brim/zeek zeek
zip -r zeek-$(git describe --dirty --tags).$goos-amd64.zip zeek
